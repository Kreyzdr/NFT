<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roll Your Chance</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background-color: #ffffff;
        }
        .container {
            width: 100%;
            max-width: 400px;
            margin: auto;
            padding: 20px;
        }
        .attempts {
            font-size: 50px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .roll-button {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            font-weight: bold;
            background-color: #e0e0e0;
            border: none;
            cursor: pointer;
        }
        .roll-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="attempts" class="attempts">3</div>
        <button id="rollBtn" class="roll-button">ROLL</button>
        <!-- Дополнительные кнопки для принятия или отклонения ролла -->
        <button id="acceptBtn" class="roll-button">Принять новый</button>
        <button id="cancelBtn" class="roll-button">Оставить прошлый</button>
        <div id="results" class="results"></div>
    </div>

    <script>
        // Получение параметра telegram_id из URL (если потребуется)
        const telegramId = new URLSearchParams(window.location.search).get("telegram_id");

        // Глобальная переменная для хранения текущего roll_id
        let currentRollId = null;

        function updateUI(data) {
            document.getElementById("attempts").textContent = data.attempts_left;
            if (data.attempts_left <= 0) {
                document.getElementById("rollBtn").disabled = true;
            }
        }

        function fetchUserData() {
            fetch(`/api/user?telegram_id=${telegramId}`)
                .then(response => response.json())
                .then(updateUI)
                .catch(console.error);
        }

        document.getElementById("rollBtn").addEventListener("click", () => {
            fetch(`/api/roll?telegram_id=${telegramId}`, { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    // Сохраняем roll_id для дальнейших действий
                    currentRollId = data.roll_id;
                    updateUI(data);
                    document.getElementById("results").innerHTML = `
                        NFT 1: ${data.probabilities.NFT1}%<br>
                        NFT 2: ${data.probabilities.NFT2}%<br>
                        NFT 3: ${data.probabilities.NFT3}%<br>
                        NFT 4: ${data.probabilities.NFT4}%<br>
                        NFT 5: ${data.probabilities.NFT5}%<br>
                        NFT 6: ${data.probabilities.NFT6}%<br>
                    `;
                })
                .catch(console.error);
        });

        // Обработчик для принятия нового ролла
        document.getElementById("acceptBtn").addEventListener("click", () => {
            if (!currentRollId) {
                alert("Сначала выполните ролл!");
                return;
            }
            fetch(`/api/rolls/${currentRollId}/accept`, { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    alert("Ролл принят: " + JSON.stringify(data.final_probabilities));
                })
                .catch(console.error);
        });

        // Обработчик для отклонения нового ролла
        document.getElementById("cancelBtn").addEventListener("click", () => {
            if (!currentRollId) {
                alert("Сначала выполните ролл!");
                return;
            }
            fetch(`/api/rolls/${currentRollId}/cancel`, { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    alert("Новый ролл отклонён");
                })
                .catch(console.error);
        });

        // Начальное получение данных пользователя
        fetchUserData();
    </script>
</body>
</html>
